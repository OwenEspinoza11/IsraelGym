<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Panel Principal - Israel Gym</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <div class="dashboard-container">
    <aside class="sidebar">
      <h2>Israel Gym</h2>
      <ul>
        <li onclick="mostrarSeccion('seccionInicio')">Inicio</li>
        <li onclick="mostrarSeccion('seccionProductos')">Productos</li>
        <li onclick="mostrarSeccion('seccionCategorias')">Categorias</li>
        <li onclick="mostrarSeccion('seccionClientes')">Clientes</li>
        <li onclick="mostrarSeccion('seccionColaboradores')" id="opColaboradores">Colaboradores</li>
        <li onclick="mostrarSeccion('seccionProveedores')" id="opProveedores">Proveedores</li>
        <li onclick="mostrarSeccion('seccionMembresias')">Membresías</li>
        <li onclick="mostrarSeccion('seccionCompras')">Compras</li>
        <li onclick="mostrarSeccion('seccionVentas')">Ventas</li>
        <li onclick="mostrarSeccion('seccionCuenta')">Mi Cuenta</li>
      </ul>
    </aside>

    <main class="main-content">
      <h1>Inicio</h1>

      <!-- <section id="seccionInicio" class="seccion">
        <h2>Inicio</h2>
         contenido cargado dinámicamente
    </section> -->

      <section id="seccionInicio" class="seccion">
        <h2>Reportes y Estadísticas</h2>

        <div class="filtros-reportes">
          <div>
            <label>Fecha inicio:</label>
            <input type="date" id="fechaInicio" value="">
          </div>
          <div>
            <label>Fecha fin:</label>
            <input type="date" id="fechaFin" value="">
          </div>
          <button onclick="cargarReportes()">Aplicar Filtros</button>
        </div>

        <div class="dashboard-grid">
          <!-- Tarjetas resumen -->
          <div class="card">
            <h3>Ventas Hoy</h3>
            <div class="valor" id="ventas-hoy">Cargando...</div>
          </div>

          <div class="card">
            <h3>Membresías Activas</h3>
            <div class="valor" id="membresias-activas">Cargando...</div>
          </div>

          <div class="card">
            <h3>Productos Bajo Stock</h3>
            <div class="valor" id="productos-bajo-stock">Cargando...</div>
          </div>

          <div class="card">
            <h3>Ingresos Mes</h3>
            <div class="valor" id="ingresos-mes">Cargando...</div>
          </div>

          <!-- Gráficos principales -->
          <div class="grafico-card">
            <h3>Ventas por Día</h3>
            <div id="grafico-ventas" style="height: 300px;"></div>
          </div>

          <div class="grafico-card">
            <h3>Productos Más Vendidos</h3>
            <div id="grafico-productos" style="height: 300px;"></div>
          </div>

          <!-- Tablas -->
          <div class="tabla-card">
            <h3>Últimas Ventas</h3>
            <div class="table-container">
              <table id="tabla-ultimas-ventas">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Fecha</th>
                    <th>Total</th>
                    <th>Productos</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div class="tabla-card">
            <h3>Inventario Bajo</h3>
            <div class="table-container">
              <table id="tabla-inventario-bajo">
                <thead>
                  <tr>
                    <th>Producto</th>
                    <th>Stock</th>
                    <th>Categoría</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>


      <section id="seccionCategorias" class="seccion">
        <h2>Categorías</h2>

        <div class="categorias-container">
          <!-- Formulario para agregar nueva categoría -->
          <div class="card form-agregar">
            <h3>Agregar Nueva Categoría</h3>
            <div class="form-group">
              <input type="text" id="nombreCategoria" placeholder="Nombre de la categoría" class="form-control">
            </div>
            <button id="btnAgregarCategoria" class="btn-primary">Agregar</button>
          </div>

          <!-- Listado de categorías -->
          <div class="card lista-categorias">
            <h3>Listado de Categorías</h3>
            <div class="table-container">
              <table id="tablaCategorias">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="cuerpoTablaCategorias">
                  <!-- Las categorías se cargarán aquí dinámicamente -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>



      <section id="seccionClientes" class="seccion">
        <h2>Clientes</h2>
        <!-- contenido cargado dinámicamente -->
      </section>



      <section id="seccionColaboradores" class="seccion">
        <h2>Colaboradores</h2>
        <!-- Solo para administrador -->
      </section>

      <section id="seccionProveedores" class="seccion">
        <h2>Proveedores</h2>
        <!-- Solo para administrador -->
      </section>

      <section id="seccionMembresias" class="seccion">
        <h2>Membresías</h2>
        <form id="formMembresia">
          <input type="hidden" id="idDetalleMembresia">
          <label>Cliente:</label>
          <input type="number" id="idCliente" required>
          <label>Membresía:</label>
          <input type="number" id="idMembresia" required>
          <label>Subtotal:</label>
          <input type="number" step="0.01" id="subtotal" required>
          <button type="submit">Guardar</button>
        </form>
        <table id="tablaMembresias">
          <thead>
            <tr>
              <th>ID</th>
              <th>Cliente</th>
              <th>Membresía</th>
              <th>Subtotal</th>
              <th>Fecha</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <section id="seccionCompras" class="seccion">
        <h2>Compras</h2>
        <!-- contenido cargado dinámicamente -->
      </section>

      <section id="seccionVentas" class="seccion">
        <h2>Ventas</h2>
        <!-- contenido cargado dinámicamente -->
      </section>

      <section id="seccionCuenta" class="seccion">
        <h2>Mi Cuenta</h2>
        <p id="infoCuenta"></p>
        <button onclick="cerrarSesion()">Cerrar sesión</button>
      </section>


      <section id="seccionProductos" class="seccion">
        <h2>Productos</h2>
        <form id="formProducto">
          <input type="hidden" id="idProducto">

          <label>Nombre del Producto:</label>
          <input type="text" id="nombreProducto" required>

          <label>Descripción:</label>
          <input type="text" id="descripcionProducto" required>

          <label>Cantidad:</label>
          <input type="number" id="cantidadProducto" required>

          <label>Precio:</label>
          <input type="number" step="0.01" id="precioProducto" required>

          <label>Costo:</label>
          <input type="number" step="0.01" id="costoProducto" required>

          <script>
            function mostrarModalCategoria() {
              document.getElementById("modalCategoria").style.display = "block";
            }

            function cerrarModalCategoria() {
              document.getElementById("modalCategoria").style.display = "none";
              document.getElementById("nuevaCategoria").value = "";
            }

            function guardarCategoria() {
              const nombre = document.getElementById("nuevaCategoria").value.trim();
              if (!nombre) {
                alert("Ingrese un nombre válido para la categoría.");
                return;
              }

              fetch("http://localhost:5000/categorias", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ nombre })
              })
                .then(res => res.json())
                .then(() => {
                  alert("Categoría agregada correctamente");
                  cerrarModalCategoria();
                  cargarCategorias();
                })
                .catch(err => {
                  console.error("Error agregando categoría:", err);
                  alert("Error al agregar la categoría");
                });
            }

            function cargarCategorias() {
              fetch("http://127.0.0.1:5000/categorias")
                .then(res => res.json())
                .then(categorias => {
                  const select = document.getElementById("categoriaProducto");
                  select.innerHTML = "";
                  categorias.forEach(cat => {
                    const option = document.createElement("option");
                    option.value = cat.id;
                    option.textContent = cat.nombre;
                    select.appendChild(option);
                  });
                });
            }

            function cargarProveedores() {
              fetch("http://localhost:5000/proveedores")
                .then(res => res.json())
                .then(proveedores => {
                  const select = document.getElementById("proveedorProducto");
                  select.innerHTML = "";
                  proveedores.forEach(prov => {
                    const option = document.createElement("option");
                    option.value = prov.id;
                    option.textContent = prov.nombre;
                    select.appendChild(option);
                  });
                });
            }

            document.getElementById("formProducto").addEventListener("submit", function (e) {
              e.preventDefault();

              const producto = {
                nombre: document.getElementById("nombreProducto").value,
                descripcion: document.getElementById("descripcionProducto").value,
                precio: parseFloat(document.getElementById("precioProducto").value),
                costo: parseFloat(document.getElementById("costoProducto").value),
                cantidad: parseInt(document.getElementById("cantidadProducto").value),
                estado: document.getElementById("estadoProducto").value,
                idCategoria: parseInt(document.getElementById("categoriaProducto").value),
                idProveedor: parseInt(document.getElementById("proveedorProducto").value)
              };

              fetch("http://127.0.0.1:5000/productos", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(producto)
              })
                .then(res => res.json())
                .then(data => {
                  alert(data.mensaje || "Producto guardado correctamente");
                  document.getElementById("formProducto").reset();
                  cargarProductos();
                })
                .catch(err => {
                  console.error("Error al guardar producto:", err);
                  alert("Error al guardar el producto");
                });
            });

            function cargarProductos() {
              fetch("http://127.0.0.1:5000/productos")
                .then(res => res.json())
                .then(productos => {
                  const tbody = document.querySelector("#tablaProductos tbody");
                  tbody.innerHTML = "";
                  productos.forEach(p => {
                    const fila = document.createElement("tr");
                    fila.innerHTML = `
              <td>${p.id}</td>
              <td>${p.nombre}</td>
              <td>${p.descripcion}</td>
              <td>${p.precio.toFixed(2)}</td>
              <td>${p.costo.toFixed(2)}</td>
              <td>${p.cantidad}</td>
              <td>${p.categoria}</td>
              <td>${p.proveedor}</td>
              <td>${p.estado}</td>
              <td><em>No disponible</em></td>
              <td><button disabled>Editar</button> <button disabled>Eliminar</button></td>
            `;
                    tbody.appendChild(fila);
                  });
                });
            }

            document.addEventListener('DOMContentLoaded', () => {
              cargarCategorias();
              cargarProveedores();
              cargarProductos();

              const btn = document.querySelector("button[data-modal='agregarCategoria']");
              if (btn) btn.addEventListener("click", mostrarModalCategoria);
            });
          </script>
          <label>Categoría:</label>
          <div style="display: flex; align-items: center; gap: 10px;">
            <select id="categoriaProducto" required></select>
            <button type="button" onclick="mostrarModalCategoria()">Agregar Categoria</button>
          </div>

          <label>Proveedor:</label>
          <select id="proveedorProducto" required></select>

          <label>Imagen:</label>
          <input type="file" id="imagenProducto" accept="image/*">

          <label>Estado:</label>
          <select id="estadoProducto" required>
            <option value="Disponible">Disponible</option>
            <option value="No disponible">No disponible</option>
          </select>

          <button type="submit">Guardar Producto</button>
        </form>

        <table id="tablaProductos">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Descripción</th>
              <th>Precio</th>
              <th>Costo</th>
              <th>Cantidad</th>
              <th>Categoría</th>
              <th>Proveedor</th>
              <th>Estado</th>
              <th>Imagen</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
  </div>
  </section>

  </main>
  </div>

  <script>
    const usuario = JSON.parse(localStorage.getItem('usuario'));
    if (!usuario) {
      alert("No has iniciado sesión");
      window.location.href = "index.html";
    }

    document.getElementById("infoCuenta").innerText = `Usuario: ${usuario.usuario} | Rol: ${usuario.rol}`;

    if (usuario.rol !== "Administrador") {
      document.getElementById('seccionColaboradores').style.display = 'none';
      document.getElementById('seccionCategoriaMembresia').style.display = 'none';
      document.getElementById('opColaboradores').style.display = 'none';
      document.getElementById('opCategoriaMembresia').style.display = 'none';
    }

    function cerrarSesion() {
      localStorage.clear();
      window.location.href = "index.html";
    }

    function mostrarSeccion(id) {
      document.querySelectorAll('.seccion').forEach(sec => sec.style.display = 'none');
      document.getElementById(id).style.display = 'block';
    }

    // Mostrar sección por defecto
    mostrarSeccion('seccionProductos');

    // Cargar membresías
    function cargarMembresias() {
      fetch("http://127.0.0.1:5000/detalle-membresias")
        .then(res => res.json())
        .then(data => {
          const tbody = document.querySelector("#tablaMembresias tbody");
          tbody.innerHTML = "";
          data.forEach(m => {
            const fila = document.createElement("tr");
            fila.innerHTML = `
              <td>${m.IdDetalleMembresia}</td>
              <td>${m.IdCliente}</td>
              <td>${m.IdMembresia}</td>
              <td>${m.Subtotal}</td>
              <td>${m.FechaAsignacion}</td>
            `;
            tbody.appendChild(fila);
          });
        });
    }

    document.getElementById("formMembresia").addEventListener("submit", function (e) {
      e.preventDefault();
      const idCliente = document.getElementById("idCliente").value;
      const idMembresia = document.getElementById("idMembresia").value;
      const subtotal = document.getElementById("subtotal").value;

      fetch("http://127.0.0.1:5000/detalle-membresias", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ idCliente, idMembresia, subtotal })
      })
        .then(res => res.json())
        .then(() => {
          alert("Membresía asignada");
          cargarMembresias();
          document.getElementById("formMembresia").reset();
        });
    });

    cargarMembresias();
  </script>

  <script>

    // Configuración inicial de fechas
    document.addEventListener('DOMContentLoaded', function () {
      const hoy = new Date();
      const primerDiaMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);

      document.getElementById('fechaInicio').value = primerDiaMes.toISOString().split('T')[0];
      document.getElementById('fechaFin').value = hoy.toISOString().split('T')[0];

      cargarReportes();
    });

    // Cargar todos los reportes
    function cargarReportes() {
      const fechaInicio = document.getElementById('fechaInicio').value;
      const fechaFin = document.getElementById('fechaFin').value;

      cargarVentasPorPeriodo(fechaInicio, fechaFin);
      cargarProductosMasVendidos();
      cargarMembresiasActivas();
      cargarInventarioBajo();
      cargarResumenes();
    }

    // Cargar ventas por período
    function cargarVentasPorPeriodo(fechaInicio, fechaFin) {
      fetch(`http://127.0.0.1:5000/reportes/ventas-por-periodo?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`)
        .then(res => res.json())
        .then(data => {
          // Actualizar gráfico de ventas
          const fechas = data.map(item => item.fecha);
          const montos = data.map(item => item.monto_total);

          if (window.ventasChart) {
            window.ventasChart.destroy();
          }

          const ctx = document.getElementById('grafico-ventas').getContext('2d');
          window.ventasChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: fechas,
              datasets: [{
                label: 'Ventas por día',
                data: montos,
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          });

          // Actualizar tabla de últimas ventas
          const tbody = document.querySelector('#tabla-ultimas-ventas tbody');
          tbody.innerHTML = '';

          // Simulamos datos de últimas ventas (deberías crear un endpoint específico para esto)
          data.slice(0, 5).forEach(venta => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
          <td>${Math.floor(Math.random() * 1000)}</td>
          <td>${venta.fecha}</td>
          <td>$${venta.monto_total.toFixed(2)}</td>
          <td>${Math.floor(Math.random() * 5) + 1} productos</td>
        `;
            tbody.appendChild(tr);
          });
        });
    }

    // Cargar productos más vendidos
    function cargarProductosMasVendidos() {
      fetch('http://127.0.0.1:5000/reportes/productos-mas-vendidos?limit=5')
        .then(res => res.json())
        .then(data => {
          const productos = data.map(item => item.producto);
          const cantidades = data.map(item => item.total_vendido);

          if (window.productosChart) {
            window.productosChart.destroy();
          }

          const ctx = document.getElementById('grafico-productos').getContext('2d');
          window.productosChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: productos,
              datasets: [{
                label: 'Unidades vendidas',
                data: cantidades,
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          });
        });
    }

    // Cargar membresías activas
    function cargarMembresiasActivas() {
      fetch('http://127.0.0.1:5000/reportes/membresias-activas')
        .then(res => res.json())
        .then(data => {
          document.getElementById('membresias-activas').textContent =
            data.reduce((sum, item) => sum + item.cantidad, 0);
        });
    }

    // Cargar inventario bajo
    function cargarInventarioBajo() {
      fetch('http://127.0.0.1:5000/reportes/inventario-bajo?umbral=10')
        .then(res => res.json())
        .then(data => {
          document.getElementById('productos-bajo-stock').textContent = data.length;

          const tbody = document.querySelector('#tabla-inventario-bajo tbody');
          tbody.innerHTML = '';

          data.slice(0, 5).forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
          <td>${item.producto}</td>
          <td class="${item.stock < 5 ? 'stock-critico' : 'stock-bajo'}">${item.stock}</td>
          <td>${item.categoria}</td>
        `;
            tbody.appendChild(tr);
          });
        });
    }

    // Cargar resúmenes
    function cargarResumenes() {
      // Ventas hoy (simulado)
      fetch('http://127.0.0.1:5000/reportes/ventas-por-periodo?fecha_inicio=' +
        new Date().toISOString().split('T')[0] +
        '&fecha_fin=' + new Date().toISOString().split('T')[0])
        .then(res => res.json())
        .then(data => {
          const totalHoy = data.reduce((sum, item) => sum + item.monto_total, 0);
          document.getElementById('ventas-hoy').textContent = `$${totalHoy.toFixed(2)}`;
        });

      // Ingresos mes (simulado)
      const primerDiaMes = new Date(new Date().getFullYear(), new Date().getMonth(), 1)
        .toISOString().split('T')[0];
      const hoy = new Date().toISOString().split('T')[0];

      fetch(`http://127.0.0.1:5000/reportes/ventas-por-periodo?fecha_inicio=${primerDiaMes}&fecha_fin=${hoy}`)
        .then(res => res.json())
        .then(data => {
          const totalMes = data.reduce((sum, item) => sum + item.monto_total, 0);
          document.getElementById('ingresos-mes').textContent = `$${totalMes.toFixed(2)}`;
        });
    }
  </script>

  <script>
document.addEventListener('DOMContentLoaded', function() {
  // Cargar categorías al iniciar
  cargarCategorias();
  
  // Evento para agregar categoría
  document.getElementById('btnAgregarCategoria').addEventListener('click', agregarCategoria);
});

function cargarCategorias() {
  fetch('http://127.0.0.1:5000/categorias')
    .then(response => {
      if (!response.ok) {
        throw new Error('Error al cargar categorías');
      }
      return response.json();
    })
    .then(data => {
      const tbody = document.getElementById('cuerpoTablaCategorias');
      tbody.innerHTML = '';
      
      data.forEach(categoria => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${categoria.id}</td>
          <td>${categoria.nombre}</td>
          <td>
            <button class="btn-danger" onclick="eliminarCategoria(${categoria.id})">Eliminar</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    })
    .catch(error => {
      console.error('Error:', error);
      alert(error.message);
    });
}

function agregarCategoria() {
  const nombre = document.getElementById('nombreCategoria').value.trim();
  
  if (!nombre) {
    alert('Por favor ingrese un nombre para la categoría');
    return;
  }
  
  fetch('http://127.0.0.1:5000/categorias', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({nombre: nombre}),
  })
  .then(response => {
    if (!response.ok) {
      return response.json().then(err => { throw new Error(err.error || 'Error al agregar categoría'); });
    }
    return response.json();
  })
  .then(data => {
    alert(data.mensaje);
    document.getElementById('nombreCategoria').value = '';
    cargarCategorias(); // Recargar la lista
  })
  .catch(error => {
    console.error('Error:', error);
    alert(error.message);
  });
}

function eliminarCategoria(id) {
  if (!confirm('¿Está seguro que desea eliminar esta categoría?')) {
    return;
  }
  
  fetch(`http://127.0.0.1:5000/categorias/${id}`, {
    method: 'DELETE',
  })
  .then(response => {
    if (!response.ok) {
      return response.json().then(err => { throw new Error(err.error || 'Error al eliminar categoría'); });
    }
    return response.json();
  })
  .then(data => {
    alert(data.mensaje);
    cargarCategorias(); // Recargar la lista
  })
  .catch(error => {
    console.error('Error:', error);
    alert(error.message);
  });
}
</script>

</body>
<!-- Modal para agregar categoría -->
<div id="modalCategoria" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="cerrarModalCategoria()">&times;</span>
    <h3>Agregar Nueva Categoría</h3>
    <input type="text" id="nuevaCategoria" placeholder="Nombre de la categoría">
    <button onclick="guardarCategoria()">Guardar</button>
  </div>
</div>

</html>
